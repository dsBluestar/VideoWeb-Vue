<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ”</text></svg>">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.6.14/vue.min.js" type="application/javascript"></script>
    <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdn.bootcss.com/hls.js/8.0.0-beta.3/hls.min.js"></script>
    <link rel="stylesheet" href="index.css">
    <title>Login &#128512;&#128512;&#128512;</title>
</head>
<body>
    <div id="Main">
        <ul>
            <li>Home</li>
            <li>Music</li>
            <li>Movie</li>
            <li>Search<input v-model="keyword" width="100px"><button @click="click_search">Search</button></li>
        </ul>
        <video id="player" controls=""></video>
        <h3>å½±è§†åˆ—è¡¨ ({{ lists.length }} éƒ¨):</h3>
        <button @click="Uppage">ä¸Šä¸€é¡µ</button>
        <button @click="Downpage">ä¸‹ä¸€é¡µ</button>
        <div v-for="movie in lists">
            <h4>{{ movie.vod_name }}</h4>
            <p>ID: {{ movie.vod_id }}</p>
            <p>ç±»å‹: {{ movie.type_name }}</p>
            <p>æ›´æ–°æ—¶é—´: {{ movie.vod_time }}</p>
            <p>å¤‡æ³¨: {{ movie.vod_remarks }}</p>
            <p>æ¼”å‘˜: {{ movie.vod_actor }}</p>
            <p>ä»‹ç»: {{ movie.vod_blurb}}</p>
            <img :src="movie.vod_pic" v-if="movie.vod_pic" width="100">
            <p v-else>No image</p>
            <div v-if="movie.vod_play_url">
                <strong>åœ¨çº¿æ’­æ”¾:</strong>
                <div>
                    <button 
                        v-for="episode in parseEpisodes(movie.vod_play_url)" 
                        :key="episode.name"
                        @click="playVideo(episode.url)"
                        style="margin: 5px; padding: 5px 10px;"
                    >
                        {{ episode.name }}
                    </button>
                </div>
            </div>
        </div>
    </div>
    <script>
        new Vue({
            el:'#Main',
            data:{
                page:1,
                keyword:'å»æœ‰é£çš„åœ°æ–¹',
                Jsoninfo:'',
                lists:[],
                pagecount:0,
                total:0
            },
            methods:{
                Uppage:function(){
                    if(this.page>1){
                        this.page-=1;
                    }

                },
                Downpage:function(){
                    this.page+=1;
                    

                },



                playVideo: function(url){
                if(!url) {
                    alert('æ— æ•ˆçš„è§†é¢‘URL');
                    return;
                }
                
                // ä½¿ç”¨æ‚¨æä¾›çš„å¯è¿è¡Œçš„æ’­æ”¾å‡½æ•°
                this.playM3u8(url);
            },
            
            playM3u8: function(url){
                if(Hls.isSupported()) {
                    var video = document.getElementById('player');
                    video.volume = 1.0;
                    var hls = new Hls();
                    const proxyUrl = 'https://api.allorigins.win/raw?url=';
                    // æ¸…ç†URL - ç§»é™¤å¯èƒ½çš„.m3u8é‡å¤åç¼€
                    var m3u8Url = decodeURIComponent(url);
                    
                    console.log('æ’­æ”¾URL:', proxyUrl+m3u8Url);
                    
                    hls.loadSource(m3u8Url);
                    hls.attachMedia(video);
                    hls.on(Hls.Events.MANIFEST_PARSED, function() {
                        video.play().catch(function(e) {
                            console.error('æ’­æ”¾å¤±è´¥:', e);
                            alert('æ’­æ”¾å¤±è´¥: ' + e.message);
                        });
                    });
                    
                    // æ·»åŠ é”™è¯¯å¤„ç†
                    hls.on(Hls.Events.ERROR, function(event, data) {
                        console.error('HLSé”™è¯¯:', data);
                        if(data.fatal) {
                            switch(data.type) {
                                case Hls.ErrorTypes.NETWORK_ERROR:
                                    alert('ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•åŠ è½½è§†é¢‘');
                                    break;
                                case Hls.ErrorTypes.MEDIA_ERROR:
                                    alert('åª’ä½“é”™è¯¯ï¼Œè§†é¢‘æ ¼å¼å¯èƒ½ä¸æ”¯æŒ');
                                    break;
                                default:
                                    alert('æ’­æ”¾é”™è¯¯: ' + data.details);
                                    break;
                            }
                        }
                    });
                } else {
                    alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒHLSæ’­æ”¾');
                }
            },
                click_search:function(){
                    this.get_api_info();
                },
                get_api_info:function(){
                    let apiUrl = `https://cj.lziapi.com/api.php/provide/vod/?ac=list&page=${this.page}`;
                    if(this.keyword){
                        apiUrl += `&wd=${encodeURIComponent(this.keyword)}`;
                    }
                    const proxyUrl = 'https://api.allorigins.win/raw?url=';
                    const finalUrl = proxyUrl + encodeURIComponent(apiUrl);
                    //(fetch) JavaScript æ¥å£
                    fetch(finalUrl)
                    .then(response => {
                        alert('Doing Analysis Data ');
                        if (!response.ok) {
                            throw new Error('ç½‘ç»œå“åº”ä¸æ­£å¸¸');
                        }
                        return response.json()
                    })
                    .then(data => {
                        alert('Analysis Data Finished');
                        if(!data.list||data.list.length==0){
                            if(this.page>1){
                                this.page-=1;
                                this.get_api_info();
                                return;
                            }
                        }
                        this.lists=data.list||[];
                        this.pagecount=data.pagecount||0;
                        this.total=data.total||0;
                        
                        
                        this.Jsoninfo = JSON.stringify(data, null, 2);
                        
                    })
                },
                parseEpisodes: function(playUrl) {
    if (!playUrl) return [];
    
    const episodes = [];
    // å…ˆæŒ‰#åˆ†å‰²ä¸åŒçš„æ’­æ”¾æº
    const sources = playUrl.split('#');
    
    for (let source of sources) {
        // åœ¨æ¯ä¸ªæ’­æ”¾æºä¸­æŒ‰$åˆ†å‰²å‰§é›†
        const parts = source.split('$');
        
        for (let i = 0; i < parts.length; i++) {
            const part = parts[i].trim();
            if (!part) continue;
            
            // æ£€æµ‹å‰§é›†åç§°ï¼ˆåŒ…å«"ç¬¬"å’Œ"é›†"ï¼‰
            if (part.includes('ç¬¬') && part.includes('é›†')) {
                const episodeName = part;
                let episodeUrl = '';
                
                // æŸ¥æ‰¾å¯¹åº”çš„URL
                if (i + 1 < parts.length) {
                    const nextPart = parts[i + 1].trim();
                    // åªè¯†åˆ«åŒ…å« .m3u8 çš„URL
                    if (nextPart && nextPart.includes('.m3u8')) {
                        episodeUrl = nextPart.replace(/\\\//g, '/');
                        i++; // è·³è¿‡URLéƒ¨åˆ†
                        
                        episodes.push({
                            name: episodeName,
                            url: episodeUrl
                        });
                    }
                }
            }
        }
    }
    const uniqueEpisodes = [];
    const seen = new Set();
    
    for (let episode of episodes) {
        const key = episode.name + episode.url;
        if (!seen.has(key)) {
            seen.add(key);
            uniqueEpisodes.push(episode);
        }
    }
    
    // æŒ‰å‰§é›†åç§°æ’åº
    uniqueEpisodes.sort((a, b) => {
        const numA = parseInt(a.name.match(/ç¬¬(\d+)é›†/)?.[1] || 0);
        const numB = parseInt(b.name.match(/ç¬¬(\d+)é›†/)?.[1] || 0);
        return numA - numB;
    });
    
    return uniqueEpisodes;
}
            }
        });
    </script>
</body>
</html>